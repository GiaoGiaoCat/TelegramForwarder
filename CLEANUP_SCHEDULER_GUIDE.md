# 临时文件自动清理功能使用指南

## 📋 功能说明

自动清理调度器会定期扫描 `temp/` 目录，删除超过指定时间的临时文件，防止硬盘空间被占满。

## ⚙️ 配置选项

在 `.env` 文件中添加以下配置：

```ini
# 临时文件清理配置
# 清理任务执行间隔（秒），默认3600（1小时）
CLEANUP_INTERVAL_SECONDS=3600

# 文件保留时长（秒），超过此时间的文件将被删除，默认3600（1小时）
CLEANUP_FILE_AGE_SECONDS=3600
```

### 配置参数说明

| 参数 | 说明 | 默认值 | 建议值 |
|------|------|--------|--------|
| `CLEANUP_INTERVAL_SECONDS` | 清理任务执行间隔（秒） | 3600 (1小时) | 3600-7200 |
| `CLEANUP_FILE_AGE_SECONDS` | 文件保留时长（秒） | 3600 (1小时) | 3600-7200 |

## 🎯 使用场景

### 场景 1: 标准配置（推荐）
适用于大多数用户，平衡了性能和硬盘使用。

```ini
CLEANUP_INTERVAL_SECONDS=3600    # 每小时清理一次
CLEANUP_FILE_AGE_SECONDS=3600    # 清理超过1小时的文件
```

### 场景 2: 频繁清理
适用于硬盘空间紧张或大量视频转发的情况。

```ini
CLEANUP_INTERVAL_SECONDS=1800    # 每30分钟清理一次
CLEANUP_FILE_AGE_SECONDS=1800    # 清理超过30分钟的文件
```

### 场景 3: 保守清理
适用于网络不稳定，文件处理时间较长的情况。

```ini
CLEANUP_INTERVAL_SECONDS=7200    # 每2小时清理一次
CLEANUP_FILE_AGE_SECONDS=7200    # 清理超过2小时的文件
```

### 场景 4: 调试模式
适用于开发调试，需要保留文件较长时间。

```ini
CLEANUP_INTERVAL_SECONDS=3600    # 每小时清理一次
CLEANUP_FILE_AGE_SECONDS=86400   # 清理超过24小时的文件
```

## 📊 清理日志示例

启动时：
```
2025-10-25 19:30:00 - INFO - 清理调度器初始化: 间隔=3600秒, 文件保留=3600秒
2025-10-25 19:30:00 - INFO - 清理调度器已启动
2025-10-25 19:30:00 - INFO - 临时文件清理调度器已启动 (间隔: 3600秒, 文件保留: 3600秒)
```

清理执行时：
```
2025-10-25 20:30:00 - INFO - 开始清理临时文件，目录: /path/to/temp
2025-10-25 20:30:00 - INFO - 已删除文件: video_123.mp4 (大小: 15.34 MB, 存在时间: 1.2小时)
2025-10-25 20:30:00 - INFO - 已删除文件: photo_456.jpg (大小: 2.45 MB, 存在时间: 1.5小时)
2025-10-25 20:30:00 - INFO - 清理完成 - 总文件数: 10 (50.23 MB), 清理文件数: 5 (25.67 MB), 剩余文件数: 5 (24.56 MB)
2025-10-25 20:30:00 - INFO - 下次清理将在 3600 秒后执行
```

## 🔧 手动清理命令

如果需要立即清理所有临时文件：

```bash
# 查看 temp 目录大小
du -sh temp/

# 清理所有临时文件
rm -rf temp/*

# 清理视频文件
find temp/ -type f \( -name "*.mp4" -o -name "*.mkv" -o -name "*.avi" -o -name "*.webm" \) -delete

# 清理缩略图
find temp/ -name "*.thumb" -delete

# 清理超过1小时的文件
find temp/ -type f -mmin +60 -delete

# 清理超过24小时的文件
find temp/ -type f -mtime +1 -delete
```

## 🎨 时间单位转换参考

| 时长 | 秒数 | 配置值 |
|------|------|--------|
| 30分钟 | 1800 | `1800` |
| 1小时 | 3600 | `3600` |
| 2小时 | 7200 | `7200` |
| 6小时 | 21600 | `21600` |
| 12小时 | 43200 | `43200` |
| 24小时 | 86400 | `86400` |

## ⚠️ 注意事项

1. **不要设置过小的值**
   - 最小建议间隔：1800秒（30分钟）
   - 最小建议保留时长：1800秒（30分钟）
   - 过小的值可能导致正在处理的文件被误删

2. **启用推送功能时的建议**
   - 如果启用了推送功能，建议保留时长至少 3600秒（1小时）
   - 推送服务不稳定时，建议延长保留时长

3. **大量视频转发时的建议**
   - 视频文件处理时间较长，建议保留时长至少 7200秒（2小时）
   - 可以降低清理间隔以更频繁地释放空间

4. **网络不稳定时的建议**
   - 增加文件保留时长，避免删除尚未完成处理的文件
   - 建议设置为 7200秒（2小时）或更长

## 🐛 故障排查

### 问题 1: 文件仍然没有被清理

**可能原因**:
- 文件创建时间未超过保留时长
- 清理任务尚未执行
- 文件权限问题

**解决方案**:
```bash
# 检查文件修改时间
ls -lht temp/

# 查看日志确认清理任务是否执行
docker logs telegram-forwarder | grep "清理"

# 手动清理测试
find temp/ -type f -mmin +60 -ls
```

### 问题 2: 清理过于频繁导致文件被误删

**可能原因**:
- 保留时长设置过短
- 文件处理时间长于保留时长

**解决方案**:
```ini
# 增加文件保留时长
CLEANUP_FILE_AGE_SECONDS=7200  # 2小时
```

### 问题 3: 清理任务未启动

**检查方法**:
```bash
# 查看启动日志
docker logs telegram-forwarder | grep "清理调度器"

# 应该看到：
# INFO - 清理调度器初始化: 间隔=3600秒, 文件保留=3600秒
# INFO - 清理调度器已启动
```

## 📈 监控建议

定期检查以下指标：

```bash
# 检查 temp 目录大小
watch -n 60 "du -sh temp/"

# 统计临时文件数量
watch -n 60 "ls temp/ | wc -l"

# 查看最近的清理日志
docker logs telegram-forwarder | tail -n 50 | grep "清理"
```

## 🔄 更新配置

修改 `.env` 文件后需要重启服务：

```bash
docker-compose restart
```

或完全重启：

```bash
docker-compose down
docker-compose up -d
```
